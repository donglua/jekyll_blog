---
layout: post
title:  "Protobuf æ€§èƒ½ä¼˜åŒ–ï¼šæ·±å…¥ç†è§£ packed=true ç¼–ç "
date:   2026-01-18 15:26:00 +0800
categories: [æŠ€æœ¯, Protobuf]
tags: [protobuf, æ€§èƒ½ä¼˜åŒ–, åºåˆ—åŒ–]
---

> åœ¨ç§»åŠ¨ç«¯å’Œç½‘ç»œé€šä¿¡åœºæ™¯ä¸­ï¼Œæ•°æ®ä¼ è¾“çš„æ•ˆç‡è‡³å…³é‡è¦ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ Protocol Buffers ä¸­çš„ `packed` ç¼–ç é€‰é¡¹ï¼Œå¸®åŠ©ä½ åœ¨å®é™…é¡¹ç›®ä¸­ä¼˜åŒ–æ•°æ®ä¼ è¾“æ€§èƒ½ã€‚

## ä¸€ã€ä»€ä¹ˆæ˜¯ packed ç¼–ç ï¼Ÿ

Protocol Buffersï¼ˆç®€ç§° Protobufï¼‰æ˜¯ Google å¼€å‘çš„ä¸€ç§é«˜æ•ˆçš„æ•°æ®åºåˆ—åŒ–æ ¼å¼ã€‚å¯¹äº `repeated` ç±»å‹çš„æ•°å€¼å­—æ®µï¼ŒProtobuf æä¾›äº†ä¸¤ç§ç¼–ç æ–¹å¼ï¼š

- **é packed ç¼–ç **ï¼šæ¯ä¸ªå…ƒç´ ç‹¬ç«‹ç¼–ç ï¼Œéƒ½å¸¦æœ‰è‡ªå·±çš„ tag
- **packed ç¼–ç **ï¼šæ‰€æœ‰å…ƒç´ æ‰“åŒ…æˆä¸€ä¸ªè¿ç»­çš„å­—èŠ‚å—ï¼Œåªæœ‰ä¸€ä¸ª tag

## äºŒã€ç¼–ç åŸç†å¯¹æ¯”

### 2.1 é packed ç¼–ç ç»“æ„

```
[tag][value1][tag][value2][tag][value3]...
```

æ¯ä¸ªå…ƒç´ éƒ½éœ€è¦é‡å¤å†™å…¥ tagï¼Œé€ æˆå¤§é‡å†—ä½™ã€‚

### 2.2 packed ç¼–ç ç»“æ„

```
[tag][total_length][value1][value2][value3]...
```

æ‰€æœ‰å…ƒç´ å…±äº«ä¸€ä¸ª tagï¼Œé€šè¿‡ length å­—æ®µæ ‡è¯†æ•°æ®æ€»é•¿åº¦ã€‚

### 2.3 ç›´è§‚å¯¹æ¯”ï¼ˆ100 ä¸ª uint64 å…ƒç´ ï¼Œæ¯ä¸ªå€¼å¹³å‡ 5 å­—èŠ‚ï¼‰

| ç‰¹æ€§ | ä¸ä½¿ç”¨ packed | ä½¿ç”¨ packed=true |
|------|:-------------:|:----------------:|
| **ç¼–ç æ–¹å¼** | æ¯ä¸ªå…ƒç´ å•ç‹¬ç¼–ç ï¼Œæ¯ä¸ªå€¼éƒ½å¸¦ tag+type+value | æ‰€æœ‰å…ƒç´ æ‰“åŒ…æˆè¿ç»­å­—èŠ‚å—ï¼Œä»…éœ€ä¸€ä¸ª tag+length å¤´éƒ¨ï¼Œåè·Ÿæ‰€æœ‰ value |
| **Wire Type** | Varint (0) | Length-delimited (2) |
| **Tag å¼€é”€** | 100 Ã— 1 = **100 å­—èŠ‚** | 1 å­—èŠ‚ |
| **Length å¼€é”€** | æ—  | 2 å­—èŠ‚ |
| **å…ƒæ•°æ®æ€»å¼€é”€** | **100 å­—èŠ‚** | **3 å­—èŠ‚** |
| **Value å¤§å°** | 500 å­—èŠ‚ | 500 å­—èŠ‚ |
| **æ€»å¤§å°** | **600 å­—èŠ‚** | **503 å­—èŠ‚** |
| **èŠ‚çœç©ºé—´** | â€” | **97 å­—èŠ‚ (16%)** |

> ğŸ’¡ å…ƒç´ æ•°é‡è¶Šå¤šï¼Œ`packed=true` èŠ‚çœçš„ç©ºé—´è¶Šæ˜¾è‘—ï¼

## ä¸‰ã€å¦‚ä½•ä½¿ç”¨ packed ç¼–ç 

### 3.1 Proto2 è¯­æ³•

åœ¨ proto2 ä¸­ï¼Œ`packed` é»˜è®¤æ˜¯å…³é—­çš„ï¼Œéœ€è¦æ˜¾å¼å£°æ˜ï¼š

```protobuf
syntax = "proto2";

message StockData {
    // é packedï¼ˆé»˜è®¤ï¼‰
    repeated uint64 prices = 1;
    
    // å¯ç”¨ packed
    repeated uint64 volumes = 2 [packed=true];
}
```

### 3.2 Proto3 è¯­æ³•

åœ¨ proto3 ä¸­ï¼Œæ•°å€¼ç±»å‹çš„ `repeated` å­—æ®µ**é»˜è®¤å¯ç”¨** packedï¼š

```protobuf
syntax = "proto3";

message StockData {
    // é»˜è®¤ packed
    repeated uint64 prices = 1;
    
    // æ˜¾å¼å…³é—­ packedï¼ˆä¸å¸¸ç”¨ï¼‰
    repeated uint64 volumes = 2 [packed=false];
}
```

### 3.3 æ”¯æŒçš„å­—æ®µç±»å‹

`packed` ç¼–ç **ä»…é€‚ç”¨äºæ ‡é‡æ•°å€¼ç±»å‹**ï¼š

| âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
|--------|----------|
| int32, int64 | string |
| uint32, uint64 | bytes |
| sint32, sint64 | åµŒå¥— message |
| fixed32, fixed64, sfixed32, sfixed64 | |
| float, double | |
| bool, enum | |

## å››ã€å…¼å®¹æ€§é—®é¢˜

### 4.1 å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸åŒæ­¥å‡çº§ä¼šæœ‰é—®é¢˜å—ï¼Ÿ

**ä¸ä¼šï¼** Protobuf è§£æå™¨è®¾è®¡äº†å‘åå…¼å®¹æœºåˆ¶ï¼š

| åœºæ™¯ | å…¼å®¹æ€§ |
|------|--------|
| æœåŠ¡ç«¯å‘é€ packedï¼Œå®¢æˆ·ç«¯æœŸæœ›é packed | âœ… å…¼å®¹ |
| æœåŠ¡ç«¯å‘é€é packedï¼Œå®¢æˆ·ç«¯æœŸæœ› packed | âœ… å…¼å®¹ |

åŸå› æ˜¯ Protobuf è§£æå™¨ä¼šæ ¹æ® wire type è‡ªåŠ¨åˆ¤æ–­æ•°æ®æ ¼å¼ï¼š
- wire type = 0 â†’ é packedï¼Œé€ä¸ªè¯»å–
- wire type = 2 â†’ packedï¼Œè¯»å–æ•´å—åè§£æ

### 4.2 æ¨èçš„å‡çº§ç­–ç•¥

è™½ç„¶ç†è®ºä¸Šå…¼å®¹ï¼Œä½†å»ºè®®é‡‡ç”¨ç¨³å¦¥ç­–ç•¥ï¼š

1. **å…ˆå‡çº§å®¢æˆ·ç«¯**ï¼ˆæ¥æ”¶æ–¹ï¼‰â€”â€” ç¡®ä¿èƒ½è§£æ packed æ ¼å¼
2. **å†å‡çº§æœåŠ¡ç«¯**ï¼ˆå‘é€æ–¹ï¼‰â€”â€” å¼€å§‹å‘é€ packed æ•°æ®

### 4.3 Protobuf åº“ç‰ˆæœ¬ vs Proto è¯­æ³•ç‰ˆæœ¬

è¿™æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æ¦‚å¿µï¼š

| æ¦‚å¿µ | è¯´æ˜ |
|------|------|
| **åº“ç‰ˆæœ¬** | è¿è¡Œæ—¶åº“ç‰ˆæœ¬ï¼ˆå¦‚ 3.21.0, 4.25.0ï¼‰ |
| **è¯­æ³•ç‰ˆæœ¬** | `.proto` æ–‡ä»¶ä¸­çš„ `syntax = "proto2"` æˆ– `"proto3"` |

ä½¿ç”¨ Protobuf åº“ 3.x/4.x ç¼–è¯‘ proto2 è¯­æ³•æ–‡ä»¶**å®Œå…¨æ­£å¸¸**ï¼Œpacked è¡Œä¸ºéµå¾ª proto æ–‡ä»¶ä¸­çš„å£°æ˜ã€‚

## äº”ã€å®æˆ˜æ¡ˆä¾‹ï¼šè‚¡ç¥¨ç­¹ç åˆ†å¸ƒæ•°æ®

ä»¥ä¸€ä¸ªå®é™…çš„é‡‘èæ•°æ®åœºæ™¯ä¸ºä¾‹ï¼š

```protobuf
syntax = "proto2";

message CyqData {
    required double min_price = 1;          // æœ€ä½ä»·æ ¼
    required double step_price = 2;         // ä»·æ ¼é—´éš”
    required double volume = 3;             // æ€»æ‰‹æ•°
    required double avg_cost_price = 4;     // å¹³å‡æˆæœ¬
    
    // ç­¹ç åˆ†å¸ƒæ•°æ®ï¼šæ¯ä¸ªä»·æ ¼æ®µçš„ç­¹ç æ•°
    // å‡è®¾æœ‰ 200 ä¸ªä»·æ ¼æ®µ
    repeated uint64 datas = 11 [packed=true];
}
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- 200 ä¸ªä»·æ ¼æ®µï¼Œæ¯ä¸ª `uint64` å¹³å‡ 5 å­—èŠ‚
- é packedï¼š200 å­—èŠ‚ tag å¼€é”€
- packedï¼š3 å­—èŠ‚ tag+length å¼€é”€
- **èŠ‚çœ 197 å­—èŠ‚ï¼ˆçº¦ 20%ï¼‰**

åœ¨ç§»åŠ¨ç«¯å¼±ç½‘ç¯å¢ƒä¸‹ï¼Œè¿™ç§ä¼˜åŒ–å¯¹ç”¨æˆ·ä½“éªŒçš„æå‡æ˜¯å®å®åœ¨åœ¨çš„ï¼

## å…­ã€æ€»ç»“

| è¦ç‚¹ | è¯´æ˜ |
|------|------|
| **é€‚ç”¨åœºæ™¯** | æ•°å€¼ç±»å‹çš„ repeated å­—æ®µï¼Œå°¤å…¶æ˜¯å…ƒç´ è¾ƒå¤šæ—¶ |
| **Proto2** | éœ€è¦æ˜¾å¼å£°æ˜ `[packed=true]` |
| **Proto3** | é»˜è®¤å¯ç”¨ï¼Œæ— éœ€é¢å¤–å£°æ˜ |
| **å…¼å®¹æ€§** | è§£æå™¨è‡ªåŠ¨å…¼å®¹ä¸¤ç§æ ¼å¼ |
| **æ€§èƒ½æå‡** | å…ƒç´ è¶Šå¤šï¼ŒèŠ‚çœè¶Šæ˜æ˜¾ |

> ğŸ¯ **ä¸€å¥è¯æ€»ç»“**ï¼šå¦‚æœä½ çš„é¡¹ç›®ä½¿ç”¨ proto2 è¯­æ³•ï¼Œä¸”æœ‰æ•°å€¼ç±»å‹çš„ repeated å­—æ®µï¼Œè®°å¾—åŠ ä¸Š `[packed=true]`ï¼Œè¿™æ˜¯å‡ ä¹é›¶æˆæœ¬çš„æ€§èƒ½ä¼˜åŒ–ï¼

---

*å‚è€ƒèµ„æ–™ï¼š*
- [Protocol Buffers å®˜æ–¹æ–‡æ¡£](https://protobuf.dev/programming-guides/encoding/)
- [Protobuf Encoding Guide](https://protobuf.dev/programming-guides/encoding/#packed)
